# =============================================================================
# DOCKER COMPOSE - PRODUCTION-GRADE WITH SECURITY HARDENING
# =============================================================================
# Standards:
# - CIS Docker Benchmark 1.5.0
# - Docker Security Best Practices 2024
# - NSA/CISA Container Hardening Guide
# =============================================================================

version: "3.9"

services:
  # ------------------------------------------
  # MAIN APPLICATION
  # ------------------------------------------
  myapp:
    build:
      context: .
      dockerfile: learn.dockerfile
      target: production
      args:
        VERSION: ${VERSION:-1.0.0}
        BUILD_DATE: ${BUILD_DATE}
        VCS_REF: ${VCS_REF}
        VCS_URL: ${VCS_URL}
        SOURCE_DATE_EPOCH: ${SOURCE_DATE_EPOCH}
      cache_from:
        - myapp:latest
      secrets:
        - github_token
    image: myapp:${VERSION:-1.0.0}
    image_tag: ["myapp:latest"]

    # ✅ Container name
    container_name: myapp-production

    # ✅ Restart policy
    restart: unless-stopped

    # ✅ Ports
    ports:
      - "3000:3000"

    # ✅ Environment variables
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0
      - NODE_OPTIONS=--max-old-space-size=2048

    env_file:
      - .env.production

    # ✅ Volumes (read-only except tmp)
    volumes:
      - /tmp
      - app-cache:/app/.next/cache:rw

    # ✅ Security Options (CRITICAL)
    security_opt:
      # ✅ No new privileges (CIS Benchmark 5.3)
      - no-new-privileges:true

      # ✅ AppArmor profile (Linux only)
      - apparmor=myapp-profile

      # ✅ Seccomp profile
      - seccomp=seccomp-profile.json

    # ✅ Read-only root filesystem (CIS Benchmark 5.18)
    read_only: true

    # ✅ Temporary filesystems
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=100m
      - /var/run:rw,noexec,nosuid,size=10m

    # ✅ Capabilities (Drop ALL, add only what's needed)
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE  # Required for binding to port < 1024
      - CHOWN             # Required for file ownership changes

    # ✅ Resource limits (CIS Benchmark 5.20, 5.21)
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
          pids: 100
        reservations:
          cpus: "0.25"
          memory: 256M

      # ✅ Restart policy
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

      # ✅ Placement constraints
      placement:
        constraints:
          - node.role == worker
        preferences:
          - spread: node.labels.zone

      # ✅ Replicas
      replicas: 3

      # ✅ Update config
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first

      # ✅ Rollback config
      rollback_config:
        parallelism: 1
        delay: 5s
        order: stop-first

    # ✅ Health check (CIS Benchmark 5.25)
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    # ✅ Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "app,version,environment"
        tag: "{{.Name}}/{{.ID}}"

    # ✅ Networks
    networks:
      - app-network
      - database-network

    # ✅ Dependencies
    depends_on:
      database:
        condition: service_healthy

    # ✅ User (non-root)
    user: "1001:1001"

    # ✅ Stop signal (graceful shutdown)
    stop_signal: SIGTERM
    stop_grace_period: 10s

    # ✅ Labels
    labels:
      - "com.myapp.description=My Application"
      - "com.myapp.version=${VERSION:-1.0.0}"
      - "com.myapp.environment=production"
      - "com.myapp.maintainer=devops@example.com"

  # ------------------------------------------
  # DATABASE (PostgreSQL example)
  # ------------------------------------------
  database:
    image: postgres:16-alpine@sha256:abc123...
    container_name: myapp-database

    restart: unless-stopped

    environment:
      - POSTGRES_DB=myapp
      - POSTGRES_USER=myapp_user
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
      - PGDATA=/var/lib/postgresql/data/pgdata

    secrets:
      - db_password

    volumes:
      - postgres-data:/var/lib/postgresql/data

    # ✅ Security options
    security_opt:
      - no-new-privileges:true
      - apparmor=postgres-profile
      - seccomp=default.json

    read_only: true

    tmpfs:
      - /var/run/postgresql:rw,noexec,nosuid
      - /tmp:rw,noexec,nosuid

    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID

    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 512M

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U myapp_user -d myapp"]
      interval: 10s
      timeout: 5s
      retries: 5

    networks:
      - database-network

    user: "999:999"

    labels:
      - "com.myapp.service=database"

  # ------------------------------------------
  # REDIS (Cache example)
  # ------------------------------------------
  redis:
    image: redis:7-alpine@sha256:def456...
    container_name: myapp-redis

    restart: unless-stopped

    command: >
      redis-server
      --requirepass /run/secrets/redis_password
      --appendonly yes
      --save 900 1
      --save 300 10

    secrets:
      - redis_password

    volumes:
      - redis-data:/data

    # ✅ Security options
    security_opt:
      - no-new-privileges:true

    read_only: true

    tmpfs:
      - /tmp:rw,noexec,nosuid

    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID

    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.25"
          memory: 128M

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

    networks:
      - app-network

    user: "999:999"

# ------------------------------------------
# NETWORKS
# ------------------------------------------
networks:
  app-network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-app
      com.docker.network.bridge.enable_icc: "false"
      com.docker.network.bridge.enable_ip_masquerade: "true"
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
    internal: false
    attachable: false

  database-network:
    driver: bridge
    internal: true  # Isolated from external network
    attachable: false

# ------------------------------------------
# VOLUMES
# ------------------------------------------
volumes:
  postgres-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/postgres

  redis-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/redis

  app-cache:
    driver: local

# ------------------------------------------
# SECRETS (External secrets management)
# ------------------------------------------
secrets:
  db_password:
    file: ./secrets/db_password.txt
  redis_password:
    file: ./secrets/redis_password.txt
  github_token:
    file: ./secrets/github_token.txt

# ------------------------------------------
# CONFIGS (Configuration files)
# ------------------------------------------
configs:
  app_config:
    file: ./config/app.json

# =============================================================================
# USAGE
# =============================================================================
# # Start services
# docker-compose -f docker-compose-security.yaml up -d
#
# # View logs
# docker-compose -f docker-compose-security.yaml logs -f
#
# # Stop services
# docker-compose -f docker-compose-security.yaml down
#
# # Scale services
# docker-compose -f docker-compose-security.yaml up -d --scale myapp=5
#
# # Update services
# docker-compose -f docker-compose-security.yaml up -d --no-deps --build myapp
#
# # Security scan
# docker scan myapp:1.0.0
# trivy image myapp:1.0.0
#
# # Check security settings
# docker inspect myapp-production | grep -A 50 "SecurityOpt"
# =============================================================================
